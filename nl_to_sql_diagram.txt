+-------------------------------+     +-------------------------------+     +-------------------------------+
|                               |     |                               |     |                               |
|  DATABASE SCHEMA EXTRACTION   |     |  NATURAL LANGUAGE PROCESSING  |     |     QUERY EXECUTION FLOW     |
|                               |     |                               |     |                               |
+-------------------------------+     +-------------------------------+     +-------------------------------+
            |                                       |                                     |
            v                                       v                                     v
+-------------------------------+     +-------------------------------+     +-------------------------------+
| 1. Connection to SQL Server   |     | 1. User inputs natural        |     | 1. Generated SQL is displayed |
|    - Credentials verification |     |    language query             |     |    to user                    |
|    - Connection establishment |     |    - Text area input          |     |    - Syntax highlighted       |
+-------------------------------+     |    - Submit button            |     |    - Editable text area       |
            |                         +-------------------------------+     +-------------------------------+
            v                                       |                                     |
+-------------------------------+                   v                                     v
| 2. Table schema retrieval     |     +-------------------------------+     +-------------------------------+
|    - get_table_schema()       |     | 2. AI prompt construction     |     | 2. Autocomplete suggestions   |
|    - Query system tables      |     |    - Schema context added     |     |    - Table/column names       |
|    - Extract columns & types  |     |    - Guidelines included      |     |    - SQL keywords             |
+-------------------------------+     |    - Response format defined   |     |    - Table-specific filtering |
            |                         +-------------------------------+     +-------------------------------+
            v                                       |                                     |
+-------------------------------+                   v                                     v
| 3. Relationship extraction    |     +-------------------------------+     +-------------------------------+
|    - get_foreign_keys()       |     | 3. Google Gemini API call     |     | 3. User reviews/edits query   |
|    - Find table relationships  |     |    - API key verification     |     |    - Keyboard navigation      |
|    - Map parent/child tables  |     |    - Model selection          |     |    - Real-time suggestions    |
+-------------------------------+     |    - Request sent to API      |     +-------------------------------+
            |                         +-------------------------------+                   |
            v                                       |                                     v
+-------------------------------+                   v                                     |
| 4. Context preparation        |     +-------------------------------+     +-------------------------------+
|    - prepare_schema_context() |     | 4. Response processing        |     | 4. Execute query button       |
|    - Format as readable text  |     |    - JSON parsing attempt     |     |    - Trigger execution        |
|    - Optimize for AI tokens   |     |    - Regex fallback option    |     |    - Show loading spinner     |
+-------------------------------+     |    - Extract SQL and reason   |     +-------------------------------+
            |                         +-------------------------------+                   |
            v                                       |                                     v
+-------------------------------+                   v                                     |
| 5. Schema context stored      |     +-------------------------------+     +-------------------------------+
|    - Saved in session state   |     | 5. Results returned to UI     |     | 5. SQL query execution        |
|    - Ready for query use      |     |    - SQL query                |     |    - execute_sql_query()      |
|    - Available for future     |     |    - Explanation text         |     |    - Database connection      |
|      requests                 |     |    - Error messages (if any)  |     |    - Query sent to server     |
+-------------------------------+     +-------------------------------+     +-------------------------------+
                                                                                          |
                                                                                          v
                                                                      +-------------------------------+
                                                                      | 6. Results processing         |
                                                                      |    - Convert to DataFrame     |
                                                                      |    - Handle empty results     |
                                                                      |    - Format for display       |
                                                                      +-------------------------------+
                                                                                          |
                                                                                          v
                                                                      +-------------------------------+
                                                                      | 7. Results display            |
                                                                      |    - Interactive table        |
                                                                      |    - Pagination support       |
                                                                      |    - CSV export option        |
                                                                      +-------------------------------+

+-----------------------------------------------------------------------------------------------+
|                                                                                               |
|                               COMPLETE PROCESS FLOW                                           |
|                                                                                               |
+-----------------------------------------------------------------------------------------------+
|                                                                                               |
|  +-------------+     +---------------+     +----------------+     +-------------+             |
|  | User selects |     | System fetches|     | User enters    |     | AI generates |            |
|  | database     | --> | schema and    | --> | natural        | --> | SQL query    |            |
|  |              |     | builds context|     | language query |     |             |            |
|  +-------------+     +---------------+     +----------------+     +-------------+             |
|         |                                                               |                     |
|         |                                                               v                     |
|         |                                                        +-------------+              |
|         |                                                        | User edits   |             |
|         |                                                        | with         |             |
|         |                                                        | autocomplete |             |
|         |                                                        +-------------+              |
|         |                                                               |                     |
|         v                                                               v                     |
|  +-------------+     +---------------+     +----------------+     +-------------+             |
|  | Query       |     | Results       |     | User views     |     | User        |            |
|  | executes on | <-- | processed     | <-- | and interacts  | <-- | executes    |            |
|  | SQL server  |     | into DataFrames|    | with results   |     | the query   |            |
|  +-------------+     +---------------+     +----------------+     +-------------+             |
|                                                                                               |
+-----------------------------------------------------------------------------------------------+ 